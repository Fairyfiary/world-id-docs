# Lens Ã— Worldcoin

Lens and Worldcoin are partnering to sustainably offer gasless transactions to real users. IDKit is integrated as a layer of protection preventing bots and other types of abuse at scale. IDKit privately verifies that a user has a unique phone number, and the Lens API ensures a single phone number is only matched to a single wallet address to receive gasless transactions.

## How does it work?

1. Your Lens app integrates IDKit JS on the frontend.
2. When the user wants to enable gasless transactions, you call IDKit with specific parameters described below.
3. The user types their phone number into IDKit and receives an SMS. They enter the code received via SMS on IDKit.
4. IDKit verifies the phone number and issues a `nullifier_hash` (a unique identifier for that phone number and the Lens ecosystem). The nullifier is fully privacy-preserving.
5. The `nullifier_hash` is sent to the Lens API, which then enables gasless transactions.

### Additional considerations

-   The user only needs to enable gasless transactions once. If a user has enabled gasless on another Lens app, then there is no need for them to go through the flow again.
-   The flow is fully privacy-preserving. Apps and Lens never see the user's phone number. The `nullifier_hash` cannot be reversed into a phone number. Worldcoin **neither stores the phone numbers nor the nullifier hashes** (see our [open source code](https://github.com/worldcoin/world-id-lens-bridge/tree/main/pages/api/v1/phone)).
-   For security, a very small list of countries are not supported, and verification is rate limited.

## Integration instructions

1. Install IDKit JS
    ```bash
    yarn add @worldcoin/idkit
    # or
    npm install @worldcoin/idkit
    ```
2. Load IDKit JS. Note the `action_id`  and `experimental_methods` parameters below -- the Action ID is the **same for all Lens-powered apps,** and `experimental_methods` must be `['phone']` or `['phone', 'orb']`.
    
    - **Action IDs:**
        - Staging Action ID: `wid_staging_ac7743b1589fefaf3ed2fc05b3d60da1`
        - Production Action ID: `wid_2d3d2e7a1e0c8286083d4e43598e4f62`
    - **Experimental methods:**
        - Only phone number verification: `["phone"]` 
        - User chooses between phone number or World ID verification: `["phone", "orb"]`

    <Note>
	The order of `phone` and `orb` in `experimental_methods` determines the order in which the user sees the options. If you want to prioritize phone number verification, put `phone` first.
    </Note>

    ```jsx
    import { IDKitWidget } from "@worldcoin/idkit";
    import { useAccount } from "wagmi";

    const { address } = useAccount()
    const is_production = process.env.NODE_ENV == "production";
    const action_id = is_production ? 'wid_2d3d2e7a1e0c8286083d4e43598e4f62' : 'wid_staging_ac7743b1589fefaf3ed2fc05b3d60da1';
    <IDKitWidget 
        actionId={action_id} 
        signal={address} 
        handleVerify={verifyProof} 
        experimental_methods={["phone", "orb"]} // or ["phone"] if you only want phone number verification
    >
        {({ open }) => (
            {/* You can render whatever you want here, and call open() to open the widget */}
            <button onClick={open}>Click me</button>
        )}
    </IDKitWidget>
    ```

3. Add the verification handler to notify the Lens API.

    ```typescript
    import type { ISuccessResult } from "@worldcoin/idkit";
    const verifyProof = useCallback(
    	async (result: IExperimentalSuccessResult) => {
    		console.log("Received successful verification from IDKit.");

    		const response = await fetch("https://world-id-lens-bridge.vercel.app/api/v1/submit", {
    			method: "POST",
    			headers: { "Content-Type": "application/json" },
    			body: JSON.stringify({
    				...result,
    				signal: address,
    				action_id,
    				is_production,
    			}),
    		});

    		// Check with Lens API if user has gasless enabled
    		if (response.ok) return;

    		if (response.status === 400 && (await response.json()).code === "already_verified") {
    			throw new Error(
    				"You have already verified this phone number with Lens. You can only verify one wallet with one phone number."
    			);
    		}

    		console.error("Failed to submit verification to Lens bridge.", response.status);
    		throw new Error();
    	},
    	[address]
    );
    ```

4. Done! The user has gasless transactions. You can optionally add an `onSuccess` handler to continue with the flow in your app.
